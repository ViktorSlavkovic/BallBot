#include <array>
#include <cstdint>
#include <cstdio>
#include <cstdlib>
#include <ctime>
#include <iostream>
#include <iterator>
#include <sstream>
#include <string>

#include <boost/asio.hpp>
#include <boost/bind.hpp>
#include <boost/date_time/posix_time/posix_time_types.hpp>

using namespace std;
using boost::asio::ip::udp;

class PwrController {
 public:
  static PwrController& Instance() {
    static PwrController crane_controller;
    return crane_controller;
  }

  void Send(uint32_t num, bool on) {
    send_buffer_[0] = num;
    send_buffer_[1] = on ? 1 : 0;
    socket_.send_to(boost::asio::buffer(send_buffer_), receiver_endpoint_);
  }

 private:
  const char* kCommandUp;
  const char* kCommandUp2;
  const char* kCommandDown;
  boost::asio::io_service io_service_;
  udp::resolver resolver_;
  udp::resolver::query query_;
  udp::endpoint receiver_endpoint_;
  udp::socket socket_;
  std::array<uint32_t, 2> send_buffer_;

  PwrController()
    : io_service_(),
      resolver_(io_service_),
      query_(udp::v4(), "vs-bgnet.ddns.net", "54321"),
      receiver_endpoint_(*resolver_.resolve(query_)),
      socket_(io_service_),
      send_buffer_() {
    socket_.open(udp::v4());
  }

  ~PwrController() {
    socket_.close();
  }

  void operator=(const PwrController&) = delete;
  void operator=(const PwrController&&) = delete;

};

const uint32_t cypher[] = {407657657,833782706,585730757,1442107688,1323774753,293060496,530179522,1146608459,1326977898,1626104655,1766394254,1373966375,1558708236,813831629,792057511,682696243,1968219393,1486289363,1757244724,1872622105,95686354,1736933358,405208723,1055933761,1047090267,211222886,377152367,2138472727,951443283,2063228556,1681237903,1359100941,749527614,119485012,653724981,2073302368,412545508,1183904503,1072427179,1739523407,662525510,691337786,966006134,73750099,1505169415,1758063646,756446342,1325905160,1096869361,366207419,1051043617,1192555715,2103140777,1456252340,101005828,1002747396,1667475226,478158195,993736475,471434862,393903104,527490731,1830535803,1143430718,646975743,336777136,1069249438,1059521252,1520681640,2141676618,651561011,35723502,685530756,1617567145,109473601,43216523,1228147143,865919944,1369121683,177532856,1232127363,272681652,1370088571,1187784492,1728933993,1471094399,43048240,1248925571,1949252595,1036784716,1720360433,195672051,1564275447,1403412588,1339102769,63767542,1740189725,260868560,1123288794,1113387717,255061530,1774849805,1149111219,940592286,1244933303,1258584821,983808809,325596798,2124504765,205446844,503129655,1209148480,478128496,1873218226,249449324,59578841,1196828978,292497564,1308504413,998597925,1329282280,881381198,1194269976,746074079,137310139,385889097,809841622,1877499864,646757657,1933130416,843403933,901819187,1560496574,1992515152,1842411473,657946229,1103616325,678736634,983543027,1080637442,884183478,1486672682,142302274,1362311975,1212407261,391751598,1421890816,261752591,684249163,582911581,1260350516,2013531443,1464292780,307136844,612121875,1601602919,693025941,1421963497,1331619135,1339783599,1207610265,27539420,94119138,620623191,2020054572,1936530612,1278569420,976187250,467783598,114628800,2056824692,1351967077,1601301482,51643319,566795404,666225095,443394917,1988686220,927977686,1127644080,424114154,40844554,993691876,1888406934,347981398,1605813751,1342526205,1041007340,880293600,526661692,233307291,2087903865,554201112,327426429,561043409,426772036,116473393,1839612829,1402959286,584256992,1954241629,1312300331,1936224069,1408059464,1363943650,355535825,2074284559,1807338567,196738397,854778598,787499000,620852551,895623152,1781190876,361775837,1243604551,1239520979,1704302042,137128243,2119814579,83480086,370435534,2060234796,637681198,697861963,473794557,1064453235,814335357,165923739,319928873,1398592349,2120165368,1632229204,1187332770,1380741184,848689206,1542868595,1307542096,508544126,1739606992,14837046,1296043126,212975896,910460198,929750354,574751733,6581101,21787685,131570128,143709344,2141602264,215050214,514144878,2054353412,852731413,1212006842,380664322,1917184648,2026342199,546588061,89629873,1277450900,519269781,1721859078,317300022,1900010966,423064636,1860168617,1060069414,931608762,1452291961,1074906460,80168240,1665267857,1985366658,1009918594,92535943,1991947760,1031706279,224106071,2135657104,1025824895,439156285,502318335,932694660,1291887698,1714325177,1313358982,1061588698,1593183728,1859947043,1151218572,723150980,231733176,725594002,1040451002,2131744142,1148658638,753135971,1044329908,2080267401,57944284,2119236368,12951993,1723212142,1957119379,1022870588,1815748085,1801583491,2054576867,2039854156,1789756947,932918115,331526793,144591634,1865612775,1623414492,1858916811,1031488109,537519542,1304616891,743951504,1688738114,2027767871,975684680,266848468,920735225,959945175,1415507107,1673871196,2004275083,1348290860,1731815481,1976027804,1361242853,1307543975,1785663535,236629793,975808412,1439763378,143723013,868178920,1082036677,1076641128,1199705713,1226628312,794770255,675636557,938061475,1826258364,1213156100,95194719,422726220,754410566,2122962590,1398410900,1021259035,896214168,210872427,289282494,422601716,67663863,1637573354,6933549,2043691667,851332559,1314477524,1681871554,1087962353,142802288,974151284,1231685366,1010981208,2056187961,160842846,63203274,1135332625,955613101,738839831,2073394101,634387817,1951995931,21105172,1057114037,558922850,2144067762,308041289,1580181885,892798282,518913717,1869464379,1315399999,586577580,1359554085,1322333548,482785599,63402996,489327425,17173505,1151365349,632129713,991324789,235567067,1643110922,900029102,396409913,1706314196,2035361728,1352023014,297670379,1961272181,1986410831,102182663,1982377353,896041220,661105513,1978961467,1204082510,93803750,724276102,1722996227,1963268129,2039676101,162090159,1175338566,1214526001,644875758,1238741562,1703853426,662049263,242623264,188499492,1653374052,478190331,1831610414,405919506,874600245,1390440962,293797586,79139611,1688111341,107586119,2065550443,1790294004,2089963472,814108015,303915869,1921441292,2018190525,397719619,498233746,1593703104,213504100,390426199,1755793263,1388842666,1604952200,253185373,480100581,1161321979,915234636,722723845,1349821471,421125040,1200914176,1033948237,827044547,2075514421,276905551,1120842133,7170385,1965016892,1228428253,2072720828,1607827249,1170908077,739345195,1911743118,944865721,610052073,161979090,1443099467,56271529,375483190,1833525666,1812064793,1764325857,1290994219,2065250166,96942790,304832550,833001155,819666635,1654654021,1254126195,2020580811,541118610,2081170742,1948611585,818024161,1054529228,1955781970,635557405,135473833,1881019150,95901006,1306381910,472880697,2007644125,103763984,1082932770,22139567,1546863451,1139204300,397622757,1232905470,803785445,14464966,376416041,721551963,111407756,681248591,1554553118,931074391,188418964,661195666,804171555,729537574,594882760,605299492,1547561735,1649411988,413597814,35635492,1784885821,147133316,131536499,943784084,620014013,2139180624,1047548068,1702946784,13836543,446927871,694667436,411459300,1679833341,1498452881,425924267,2056249382,72521196,537332023,590014325,1627074315,1468406415,778433289,140786333,125094322,1507970863,735669093,730393814,908048950,237597434,1143991628,943684443,2022483255,1291124944,1075220942,818783691,1911138957,1066917918,1866331759,1466602093,1080754461,165775983,13785881,1492213761,1845609324,1512238762,1918138028,1754375059,1584759959,307986404,196905736,1064350626,1776392819,975339026,1205136959,1901487141,335826241,1940806052,484397307,1243875192,30919838,1628388935,40075987,2053403094,772030231,1115296929,724703137,535685540,34731199,443551249,2002287634,1115485660,609327232,2016073515,460215773,307452908,1380828630,230870154,2061827967,818104941,538856558,111250056,1882455567,167765729,1086589082,940108878,2069252870,1422415323,733431282,406166529,518806867,764351121,2034555464,558882854,670270567,659102047,1674179783,1394973704,1194787587,1708910982,1838524953,1049591573,676912994,300368537,918181441,1137128768,607821446,151526423,1367998922,522165765,969631364,1906855480,633415821,704603283,2074621209,1720004903,1644712161,1996390431,994936579,230659795,255073312,1513743446,995010916,142145128,2072626301,1665281483,801247175,1599322436,912771540,1996034762,1160749771,603812845,898142688,1837662765,904181383,1816324129,827307885,1512002829,1967850552,47823159,2034168594,789998268,1954678639,520100768,1494601551,1881816200,92622023,991830064,1730722983,1087558602,1222489859,1985796295,453818401,70017128,2127941423,378961054,1735298611,781704950,1978283490,500586503,630256065,991549613,1104399349,1528398753,681728731,2008580732,1197239234,1509036616,1373099913,1017606138,1556859776,1259784859,1807604406,1364054767,1779885627,1154722309,1098387320,1872507651,2146552373,681626655,812582605,1221558584,519939303,1266401006,1291575712,500397078,1645362060,879390676,1282102029,1476161903,1379977179,1912358094,320227868,336892880,1293273199,1001956599,197989964,343028785,363509568,1571089877,1360634923,1920369344,683391089,1020755681,1136940463,315793068,27994342,87844135,40817071,27063067,769470791,853399677,1248621651,1289410094,2119800683,392713716,1789807172,1617679096,1272104392,924425553,946357351,504597923,689299999,1266585219,841490804,1982573198,121058171,1039480768,178118335,484567739,463086998,1538753258,257453435,1146478087,412025291,1394393898,1462271155,440019633,1482238034,1503088227,467082700,104225177,209004256,1715704352,1393635271,181321291,2108418068,1035958795,1799000387,1233038812,1960384349,597874090,1737636735,502200700,1864459310,431643891,337290251,1985517481,1471124660,515408586,322601572,1934211658,2054161845,580055007,933206097,318703488,1974448905,247993604,758723122,1309203291,1751081831,1225805822,1413428468,1960086087,794026526,659580091,2141407379,754960946,1695538887,1792924118,1987999758,1508439588,243314561,1578152846,2010640288,2107773871,2009796737,200446891,1945807704,1333437749,715855478,120925628,1120165759,622533675,700980635,2053371856,941237163,527945892,153881813,1699960285,1837149184,1904963644,778282460,1103094004,1717566084,1572308986,1762674096,1711489815,179786285,1310729335,1356930285,20302395,671685275,1600244846,1598455241,534841915,1560535069,1460768331,735288807,1358859125,646722432,1451144285,1479784753,1766888192,2073677960,33281740,1672776400,867431475,561227633,1826658213,419908113,250893169,1584138210,1198190573,1353987173,1154220646,623015911,969177621,718226813,802802196,132423308,2075157098,823104592,804108583,1527918297,274076185,1338950499,940969718,1734844516,2074239306,152345196,234083301,1377899943,1632129949,2000971493,1304094255,1665411690,1526264245,24042082,79155675,1205438811,443950195,330048844,642093373,1642140768,1684036017,1796314019,117673032,505729991,367057184,920475228,638153299,294730634,1743579820,1442261883,1822648931,2017656006,633728734,616135002,1605016874,560484392,768480198,1839100175,1938384335,253126499,1692588020,1094994942,1918538189,1071368618,1119037024,1997693864,129323781,1562987220,180259060,771417154,1057644340,1864295078,420247525,1175317372,222541421,787304709,2095792601,860694720,1082035343,1691888773,155472955,757200627,1562061131,789201689,1373335629,1019594358,1349686081,2141815827,711210885,1140586768,247458678,256315258,88098062,18513220,1327683876,1207135087,2016207084,1457007657,622638659,48982497,80941163,1680282999,1913277575,501188688,708116724,2135818996,1288493397,656425677,849030068,223045092,200830802,1004503024,980245719,1762891934,1793704713,206097700,635002644,995907147,200429879,1346213529,2136493915,447888558,1602528787,77108330,466401778,782729015,1284243417,335125214,92253024,1906882076,384107711,173194187,1439681427,149901638,674382875,314503,138236986,1962876272,656740180,987267055,38437717,857570983,0};
const int max_cypher_idx = 1000;

int main(int argc, char* argv[]) {
  if (argc != 2) {
    fprintf(stderr, "Invalid number of arguments!\n");
    return -1;
  }
  bool val;
  if (strcmp(argv[1], "on") == 0) {
    printf("ON\n");
    val = true;
  } else if (strcmp(argv[1], "off") == 0) {
    printf("OFF\n");    
    val = false;
  } else {
    fprintf(stderr, "Invalid first arguemnt! Should be \"on\" or \"off\".\n");
    return -3;
  }
  
  int idx = 0;

  FILE* f = fopen("cypher_idx", "r");
  if (f != nullptr) {
    fscanf(f, "%d", &idx);
    printf("reading ok, idx: %d\n", idx);
    fclose(f);
  } else {
    fprintf(stderr, "Warning: Cannot open cypher_idx file, assuming 0.\n");
  }
  f = fopen("cypher_idx", "w");
  if (f == nullptr) {
    fprintf(stderr, "Error while openning cypher_idx file for writing.\n");
    return -2;
  }
  printf("calling with %u\n", cypher[idx]);
  PwrController::Instance().Send(cypher[idx], val);
  fprintf(f, "%d\n", (idx + 1) % max_cypher_idx);
  fclose(f);
  return 0;
}

